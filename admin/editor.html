<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Editor - Life's Quirks</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìù</text></svg>">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/admin.css">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- EasyMDE Markdown Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
</head>
<body class="admin-page">
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <h2>Admin Panel</h2>
            <ul class="admin-nav">
                <li class="admin-nav-item">
                    <a href="index.html" class="admin-nav-link">Dashboard</a>
                </li>
                <li class="admin-nav-item">
                    <a href="posts.html" class="admin-nav-link">Posts</a>
                </li>
                <li class="admin-nav-item">
                    <a href="categories.html" class="admin-nav-link">Categories</a>
                </li>
                <li class="admin-nav-item">
                    <a href="comments.html" class="admin-nav-link">Comments</a>
                </li>
                <li class="admin-nav-item">
                    <a href="editor.html" class="admin-nav-link active">New Post</a>
                </li>
                <li class="admin-nav-item">
                    <a href="#" onclick="logout()" class="admin-nav-link">Logout</a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-header">
                <h1 id="editor-title">New Post</h1>
            </div>

            <form id="post-form" class="admin-form">
                <input type="hidden" id="post-id" name="id">
                
                <div class="form-group">
                    <label for="title">Title *</label>
                    <input type="text" id="title" name="title" required>
                </div>

                <div class="form-group">
                    <label for="slug">Slug (auto-generated from title)</label>
                    <input type="text" id="slug" name="slug">
                </div>

                <div class="form-group">
                    <label for="excerpt">Excerpt</label>
                    <textarea id="excerpt" name="excerpt" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="content">Content (Markdown) *</label>
                    <textarea id="content" name="content" rows="20"></textarea>
                </div>

                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" name="category_id">
                        <option value="">No category</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tags">Tags (comma-separated)</label>
                    <input type="text" id="tags" name="tags" placeholder="tag1, tag2, tag3">
                </div>

                <div class="form-group">
                    <label for="featured_image">Featured Image</label>
                    <input type="file" id="featured_image" name="featured_image" accept="image/*">
                    <div id="image-preview" style="margin-top: var(--spacing-sm); display: none;">
                        <img id="preview-img" src="" alt="Preview" style="max-width: 300px; max-height: 200px; border-radius: var(--radius-md);">
                        <p id="image-path" style="margin-top: var(--spacing-xs); font-size: 0.9em; color: var(--text-secondary);"></p>
                    </div>
                    <input type="hidden" id="featured_image_url" name="featured_image_url">
                    <small style="display: block; margin-top: var(--spacing-xs); color: var(--text-secondary);">
                        Upload an image to save it in the repository
                    </small>
                </div>

                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="draft">Draft</option>
                        <option value="published">Published</option>
                        <option value="archived">Archived</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="featured">
                        <input type="checkbox" id="featured" name="featured"> Featured Post
                    </label>
                </div>

                <div class="form-group">
                    <label for="published_at">Published At</label>
                    <input type="datetime-local" id="published_at" name="published_at">
                    <small style="display: block; margin-top: var(--spacing-xs); color: var(--text-secondary);">
                        Auto-set when status is changed to "Published"
                    </small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Post</button>
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">Cancel</button>
                </div>

                <div id="message" style="margin-top: var(--spacing-md);"></div>
            </form>
        </main>
    </div>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/admin.js"></script>
    
    <script>
        let editingPostId = null;
        let categories = [];
        let tags = [];
        let easyMDE = null;
        
        // Initialize EasyMDE
        function initEasyMDE() {
            easyMDE = new EasyMDE({
                element: document.getElementById('content'),
                spellChecker: false,
                autosave: {
                    enabled: false
                },
                placeholder: 'Write your post content in Markdown...',
                toolbar: [
                    'bold', 'italic', 'strikethrough', '|',
                    'heading-1', 'heading-2', 'heading-3', '|',
                    'code', 'quote', 'unordered-list', 'ordered-list', '|',
                    'link', 'image', 'table', '|',
                    'preview', 'side-by-side', 'fullscreen', '|',
                    'guide'
                ],
                minHeight: '400px',
                status: ['lines', 'words', 'cursor']
            });
        }

        // Load categories
        async function loadCategories() {
            try {
                categories = await api.request('/api/admin/categories');
                const select = document.getElementById('category');
                select.innerHTML = '<option value="">No category</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load tags
        async function loadTags() {
            try {
                tags = await api.request('/api/admin/tags');
            } catch (error) {
                console.error('Error loading tags:', error);
            }
        }

        // Load post if editing
        async function loadPost() {
            const params = new URLSearchParams(window.location.search);
            const postId = params.get('id');
            
            if (!postId) {
                loadCategories();
                loadTags();
                return;
            }

            editingPostId = postId;
            document.getElementById('editor-title').textContent = 'Edit Post';

            try {
                const posts = await api.request('/api/admin/posts');
                const post = posts.find(p => p.id === postId);
                
                if (!post) {
                    document.getElementById('message').textContent = 'Post not found';
                    return;
                }

                // Fill form
                document.getElementById('post-id').value = post.id;
                document.getElementById('title').value = post.title;
                document.getElementById('slug').value = post.slug;
                document.getElementById('excerpt').value = post.excerpt || '';
                // Set EasyMDE content
                if (easyMDE) {
                    easyMDE.value(post.content || '');
                } else {
                    document.getElementById('content').value = post.content;
                }
                
                // Handle featured image
                const featuredImageUrl = post.featured_image_url || '';
                document.getElementById('featured_image_url').value = featuredImageUrl;
                if (featuredImageUrl) {
                    // Show existing image preview
                    const imagePreview = document.getElementById('image-preview');
                    const previewImg = document.getElementById('preview-img');
                    const imagePath = document.getElementById('image-path');
                    previewImg.src = featuredImageUrl;
                    imagePath.textContent = `Current image: ${featuredImageUrl}`;
                    imagePreview.style.display = 'block';
                }
                
                document.getElementById('status').value = post.status || 'draft';
                document.getElementById('featured').checked = post.featured || false;
                
                if (post.published_at) {
                    const date = new Date(post.published_at);
                    const localDate = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
                    document.getElementById('published_at').value = localDate.toISOString().slice(0, 16);
                } else if (post.status === 'published' && !post.published_at) {
                    // Auto-set published_at if status is published but date is missing
                    const now = new Date();
                    const localDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
                    document.getElementById('published_at').value = localDate.toISOString().slice(0, 16);
                }

                await loadCategories();
                if (post.category_id) {
                    document.getElementById('category').value = post.category_id;
                }

                await loadTags();
                if (post.tags && post.tags.length > 0) {
                    document.getElementById('tags').value = post.tags.map(t => t.name).join(', ');
                }

            } catch (error) {
                console.error('Error loading post:', error);
                document.getElementById('message').textContent = '';
            }
        }

        // Auto-generate slug from title
        document.getElementById('title').addEventListener('input', (e) => {
            if (!document.getElementById('post-id').value) {
                const slug = utils.slugify(e.target.value);
                document.getElementById('slug').value = slug;
            }
        });

        // Auto-set published_at when status changes to published
        document.getElementById('status').addEventListener('change', (e) => {
            const publishedAtInput = document.getElementById('published_at');
            if (e.target.value === 'published' && !publishedAtInput.value) {
                const now = new Date();
                const localDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
                publishedAtInput.value = localDate.toISOString().slice(0, 16);
            }
        });

        // Handle image upload
        const imageInput = document.getElementById('featured_image');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const imagePath = document.getElementById('image-path');
        const imageUrlInput = document.getElementById('featured_image_url');

        imageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) {
                imagePreview.style.display = 'none';
                imageUrlInput.value = '';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = (event) => {
                previewImg.src = event.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // Upload file
            try {
                const uploadFormData = new FormData();
                uploadFormData.append('file', file);
                uploadFormData.append('context', 'blog');

                const token = localStorage.getItem('access_token');
                const apiUrl = window.API_URL || '';
                const response = await fetch(`${apiUrl}/api/admin/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: uploadFormData
                });

                if (!response.ok) {
                    throw new Error('Upload failed');
                }

                const result = await response.json();
                imageUrlInput.value = result.url; // Set the relative path
                imagePath.textContent = `Saved to: ${result.path}`;
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('Failed to upload image. Please try again.');
                imageInput.value = '';
                imagePreview.style.display = 'none';
            }
        });

        // Handle form submission
        document.getElementById('post-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageEl = document.getElementById('message');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            messageEl.textContent = '';

            const formData = new FormData(e.target);
            
            // Parse tags
            const tagsInput = formData.get('tags');
            let tagIds = [];
            if (tagsInput) {
                const tagNames = tagsInput.split(',').map(t => t.trim()).filter(t => t);
                for (const tagName of tagNames) {
                    const tagSlug = utils.slugify(tagName);
                    const existingTag = tags.find(t => t.slug === tagSlug);
                    if (existingTag) {
                        tagIds.push(existingTag.id);
                    } else {
                        // Create new tag
                        try {
                            const newTag = await api.request('/api/admin/tags', 'POST', {
                                name: tagName,
                                slug: tagSlug
                            });
                            tagIds.push(newTag.id);
                            tags.push(newTag);
                        } catch (error) {
                            console.error('Error creating tag:', error);
                        }
                    }
                }
            }

            // Get content from EasyMDE if available, otherwise from textarea
            const content = easyMDE ? easyMDE.value() : formData.get('content');
            
            // Validate content
            if (!content || content.trim() === '') {
                messageEl.textContent = 'Content is required';
                messageEl.style.color = 'var(--error-color, #dc3545)';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Post';
                return;
            }
            
            const postData = {
                id: formData.get('id') || null,
                title: formData.get('title'),
                slug: formData.get('slug') || utils.slugify(formData.get('title')),
                excerpt: formData.get('excerpt'),
                content: content,
                featured_image_url: formData.get('featured_image_url'),
                category_id: formData.get('category_id') || null,
                status: formData.get('status'),
                featured: formData.get('featured') === 'on',
                published_at: formData.get('published_at') || null,
                tags: tagIds
            };

            try {
                await api.request('/api/admin/posts', 'POST', postData);
                messageEl.textContent = 'Post saved successfully!';
                messageEl.style.color = 'var(--accent-color)';
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            } catch (error) {
                console.error('Error saving post:', error);
                messageEl.textContent = '';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Post';
            }
        });

        function logout() {
            api.logout();
            window.location.href = 'login.html';
        }

        // Initialize EasyMDE when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initEasyMDE();
                loadPost();
            });
        } else {
            initEasyMDE();
            loadPost();
        }
    </script>
</body>
</html>


