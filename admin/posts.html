<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts - Admin - Life's Quirks</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìù</text></svg>">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/admin.css">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="admin-page">
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <h2>Admin Panel</h2>
            <ul class="admin-nav">
                <li class="admin-nav-item">
                    <a href="index.html" class="admin-nav-link">Dashboard</a>
                </li>
                <li class="admin-nav-item">
                    <a href="posts.html" class="admin-nav-link active">Posts</a>
                </li>
                <li class="admin-nav-item">
                    <a href="categories.html" class="admin-nav-link">Categories</a>
                </li>
                <li class="admin-nav-item">
                    <a href="comments.html" class="admin-nav-link">Comments</a>
                </li>
                <li class="admin-nav-item">
                    <a href="editor.html" class="admin-nav-link">New Post</a>
                </li>
                <li class="admin-nav-item">
                    <a href="#" onclick="logout()" class="admin-nav-link">Logout</a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-header">
                <h1>Posts</h1>
                <div style="display: flex; gap: var(--spacing-sm);">
                    <button class="btn btn-secondary" onclick="showCategoryModal()">New Category</button>
                    <a href="editor.html" class="btn btn-primary">New Post</a>
                </div>
            </div>

            <div id="admin-posts">
                <div id="posts-list" class="admin-list">
                    <!-- Posts will be loaded here -->
                </div>
            </div>
        </main>

        <!-- Category Modal -->
        <div id="category-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="category-modal-title">New Category</h2>
                    <button class="modal-close" onclick="closeCategoryModal()">&times;</button>
                </div>
                <form id="category-form" class="admin-form">
                    <input type="hidden" id="category-id" name="id">
                    
                    <div class="form-group">
                        <label for="category-name">Name *</label>
                        <input type="text" id="category-name" name="name" required>
                    </div>

                    <div class="form-group">
                        <label for="category-slug">Slug (auto-generated from name)</label>
                        <input type="text" id="category-slug" name="slug">
                    </div>

                    <div class="form-group">
                        <label for="category-description">Description</label>
                        <textarea id="category-description" name="description" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="category-color">Color</label>
                        <input type="color" id="category-color" name="color" value="#0c71c3">
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Category</button>
                        <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">Cancel</button>
                    </div>

                    <div id="category-message" style="margin-top: var(--spacing-md);"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/admin.js"></script>
    
    <script>
        function logout() {
            api.logout();
            window.location.href = 'login.html';
        }

        let editingCategoryId = null;

        function showCategoryModal(categoryId = null) {
            editingCategoryId = categoryId;
            const modal = document.getElementById('category-modal');
            const form = document.getElementById('category-form');
            const title = document.getElementById('category-modal-title');
            
            if (categoryId) {
                title.textContent = 'Edit Category';
                loadCategoryForEdit(categoryId);
            } else {
                title.textContent = 'New Category';
                form.reset();
                document.getElementById('category-id').value = '';
                document.getElementById('category-color').value = '#0c71c3';
            }
            
            modal.style.display = 'flex';
        }

        function closeCategoryModal() {
            document.getElementById('category-modal').style.display = 'none';
            editingCategoryId = null;
        }

        async function loadCategoryForEdit(categoryId) {
            try {
                const categories = await api.request('/api/admin/categories');
                const category = categories.find(c => c.id === categoryId);
                
                if (category) {
                    document.getElementById('category-id').value = category.id;
                    document.getElementById('category-name').value = category.name;
                    document.getElementById('category-slug').value = category.slug;
                    document.getElementById('category-description').value = category.description || '';
                    document.getElementById('category-color').value = category.color || '#0c71c3';
                }
            } catch (error) {
                console.error('Error loading category:', error);
            }
        }

        // Auto-generate slug from name
        document.getElementById('category-name').addEventListener('input', (e) => {
            if (!document.getElementById('category-id').value) {
                const slug = utils.slugify(e.target.value);
                document.getElementById('category-slug').value = slug;
            }
        });

        // Handle form submission
        document.getElementById('category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageEl = document.getElementById('category-message');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            messageEl.textContent = '';

            const formData = new FormData(e.target);
            const categoryData = {
                id: formData.get('id') || null,
                name: formData.get('name'),
                slug: formData.get('slug') || utils.slugify(formData.get('name')),
                description: formData.get('description'),
                color: formData.get('color')
            };

            try {
                await api.request('/api/admin/categories', 'POST', categoryData);
                messageEl.textContent = 'Category saved successfully!';
                messageEl.style.color = 'var(--accent-color)';
                
                setTimeout(() => {
                    closeCategoryModal();
                    // Reload categories if on categories page, otherwise just close
                    if (typeof loadCategories === 'function') {
                        loadCategories();
                    }
                }, 1000);
            } catch (error) {
                console.error('Error saving category:', error);
                messageEl.textContent = 'Error saving category. Please try again.';
                messageEl.style.color = 'var(--error-color, #dc3545)';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Category';
            }
        });

        // Close modal when clicking outside
        document.getElementById('category-modal').addEventListener('click', (e) => {
            if (e.target.id === 'category-modal') {
                closeCategoryModal();
            }
        });
    </script>
</body>
</html>

